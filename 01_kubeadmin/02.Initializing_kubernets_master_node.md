### Introduction

You will use  `kubeadm`  to initialize the master node in this Lab Step. The initialization process will create a certificate authority for secure cluster communication and authentication, and start all the node components (`kubelet`), master components (API server, controller manager, scheduler, etcd), and common add-ons (`kube-proxy`, DNS). You will see how easy the initialization process is with  `kubeadm`.

The initialization uses sensible default values that adhere to best practices. However,  [many command options](https://kubernetes.io/docs/reference/setup-tools/kubeadm/kubeadm-init/#options)  are available to configure the process, including if you want to provide your own certificate authority or if you want to use an external etcd key-value store. One option that you will use is required by the pod network plugin that you will install after the master is initialized.  `kubeadm`  does not install a default network plugin for you. You will use Calico as the pod network plugin. Calico supports Kubernetes network policies. For network policies to function properly, you must use the  `--pod-network-cidr` option to specify a range of IP addresses for the pod network when initializing the master node with  `kubeadm`.

There are many network plugins besides Calico. Calico is used primarily because it is used in clusters in  [Kubernetes certification exams](https://www.cncf.io/certification/tips) and it supports network policies. Calico is used internally by AWS, Azure, and GCP for their managed Kubernetes offerings, so you can be certain it is production-ready. However, if all of your environments live in AWS, you may consider the  [Amazon VPC network plugin](https://github.com/aws/amazon-vpc-cni-k8s).

### Instructions

1. Initialize the master node using the init command:

```
sudo kubeadm init --pod-network-cidr=192.168.0.0/16 --kubernetes-version=stable-1.13
```

The pod network CIDR block (`192.168.0.0/16`) is the default used by Calico. The CIDR does not overlap with the Amazon VPC network CIDR used in this Lab. If it did, you would need to perform additional configuration of Calico later on to avoid the overlap. The output reports the steps that  `kubeadm`  takes to initialize the master:

![alt](https://assets.cloudacademy.com/bakery/media/uploads/blobid0-34d5b9c2-4115-4a73-a460-abb46627481b.png)

Read through the output to understand what is happening. At the end of the output, useful commands for configuring  `kubectl`  and joining worker nodes to the cluster are given:

![alt](https://assets.cloudacademy.com/bakery/media/uploads/blobid2-b5cc12f2-118e-4ef1-a46c-48b4aa400604.png)

2. Copy the `kubeadm join`  command at the end of the output and store it somewhere you can access later.

It is simply convenient to reuse the given command, although you can regenerate it and create new tokens using the  `kubeadm token`  command. The join tokens expire after 24 hours by default.

3. Initialize your user's default  `kubectl`  configuration using the admin kubeconfig file generated by  `kubeadm`:
```
mkdir -p $HOME/.kube  
sudo cp -i /etc/kubernetes/admin.conf $HOME/.kube/config  
sudo chown $(id -u):$(id -g) $HOME/.kube/config
```
4. Confirm you can use  `kubectl`  to get the cluster component statuses:
```
kubectl get componentstatuses
```
![alt](https://assets.cloudacademy.com/bakery/media/uploads/blobid3-0d4007ff-ed92-443c-9316-0fd81fba3d8c.png)

The output confirms that the **scheduler**, **controller-manager**, and **etcd**  are all **Healthy**. The Kubernetes API server is also operational, or  `kubectl`  would have returned an error attempting to connect to the API server. Enter `kubeadm token --help` if you would like to know more about  `kubeadm`  tokens.

5. Get the nodes in the cluster:
```
kubectl get nodes
```
![alt](https://assets.cloudacademy.com/bakery/media/uploads/blobid0-f6762772-9513-43e6-8c5a-a84b699e17d8.png)

The **master**  node is reporting a **STATUS**  of **NotReady**. Notice  `kubeadm`  gives the node a **NAME**  based on its IP address. The  `--node-name`  option can be used to override the default behavior.

6. Describe the node to probe deeper into its NotReady status:
```
kubectl describe nodes
```
In the **Conditions**  section of the output, observe the **Ready**  condition is False, and read the  **Message**:

![alt](https://assets.cloudacademy.com/bakery/media/uploads/blobid1-d8ee6f87-173d-4642-8516-30070b51b7b2.png)

The kubelet is not ready because the network plugin is not ready. The **cni config uninitialized** refers to the  [container network interface](https://github.com/containernetworking/cni)  (CNI) and is a related problem. Network plugins implement the CNI interface. You will resolve the issue by initializing the Calico network plugin.

7. Enter the following commands to install the Calico pod network plugin:
```
kubectl apply -f https://docs.projectcalico.org/v3.1/getting-started/kubernetes/installation/hosted/rbac-kdd.yaml  
kubectl apply -f https://docs.projectcalico.org/v3.1/getting-started/kubernetes/installation/hosted/kubernetes-datastore/calico-networking/1.7/calico.yaml
```
![alt](https://assets.cloudacademy.com/bakery/media/uploads/blobid1-fd3031e3-e826-4c65-b1a3-5fd74b741261.png)

The commands first install the cluster roles and bindings that are used by Calico (`rbac-kdd.yaml`). Then a variety of resources are created to support pod networking. A  **daemonset**  is used to run a  **calico-node**  pod on each node in the cluster. The resources include several custom resources (**customresourcedefinition**) that extend the Kubernetes API, for example, to support network policies (**networkpolicies.crd.projectcalico.org**). Many network plugins have a similar installation procedure.

8. Check the status of the nodes in the cluster:
```
kubectl get nodes
```
![alt](https://assets.cloudacademy.com/bakery/media/uploads/blobid2-3c1ee2c7-8b6b-4605-b633-4564a12fc6bc.png)

With the network plugin initialized, the master node is now **Ready**.

_Note_: It may take a minute to reach the **Ready** state.

### Summary

In this Lab Step, you used  `kubeadm`  to initialize a master node. You also initialized a pod network plugin named Calico to fully bring up the master node. The EC2 instance type used in the Lab does not have enough CPU capacity to satisfy the CPU resource requests of all of the pods on one instance. The  `kube-dns`  pod is currently unschedulable due to a lack of CPU resources, although the cluster can operate without it. Once you join a worker node to the cluster in the next Lab Step, there will be enough CPU capacity for the  `kube-dns`  pod.

It is worth mentioning that with a single master, there is a single point of failure. This is not a problem for the Lab environment, but you should consider if you require high-availability for your cluster. The procedure is outside of the scope of this Lab, but involves using a load balancer to distribute requests across API servers running on multiple master nodes. The etcd key-value store must also run in distributed mode across multiple nodes.
